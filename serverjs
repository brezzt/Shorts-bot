const http=require('http'),https=require('https'),fs=require('fs'),path=require('path'),qs=require('querystring');
const PORT=process.env.PORT||3000,BASE=process.env.BASE_URL||`http://localhost:${PORT}`;
const CF=path.join(__dirname,'config.json'),DB=path.join(__dirname,'data.json');
function lc(){try{return JSON.parse(fs.readFileSync(CF,'utf8'))}catch{return{}}}
function sc(c){fs.writeFileSync(CF,JSON.stringify(c,null,2))}
function ld(){try{return JSON.parse(fs.readFileSync(DB,'utf8'))}catch{return{videos:[],tokens:null,channel:null}}}
function sd(d){fs.writeFileSync(DB,JSON.stringify(d,null,2))}
function authUrl(id){return`https://accounts.google.com/o/oauth2/v2/auth?`+new URLSearchParams({client_id:id,redirect_uri:`${BASE}/auth/callback`,response_type:'code',scope:'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly',access_type:'offline',prompt:'consent'})}
function post(host,p,data){return new Promise((res,rej)=>{const b=qs.stringify(data),o={hostname:host,path:p,method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','Content-Length':Buffer.byteLength(b)}};const r=https.request(o,x=>{let d='';x.on('data',c=>d+=c);x.on('end',()=>{try{res(JSON.parse(d))}catch{res(d)}})});r.on('error',rej);r.write(b);r.end()})}
function get(url,h={}){return new Promise((res,rej)=>{const u=new URL(url);https.get({hostname:u.hostname,path:u.pathname+u.search,headers:h},x=>{let d='';x.on('data',c=>d+=c);x.on('end',()=>{try{res(JSON.parse(d))}catch{res(d)}})}).on('error',rej)})}
async function token(){const db=ld(),c=lc();if(!db.tokens)throw new Error('Not authenticated');if(Date.now()<(db.tokens.expiry||0)-60000)return db.tokens.access_token;const r=await post('oauth2.googleapis.com','/token',{refresh_token:db.tokens.refresh_token,client_id:c.clientId,client_secret:c.clientSecret,grant_type:'refresh_token'});if(r.error)throw new Error('Refresh failed');db.tokens.access_token=r.access_token;db.tokens.expiry=Date.now()+(r.expires_in*1000);sd(db);return r.access_token}
async function channel(t){const d=await get('https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&mine=true',{Authorization:`Bearer ${t}`});if(d.items&&d.items[0]){const c=d.items[0];return{id:c.id,title:c.snippet.title,handle:c.snippet.customUrl||c.snippet.title,subscribers:c.statistics.subscriberCount,views:c.statistics.viewCount}}return null}
function gen(topic,tone,len){const hooks=[`Nobody talks about this ‚Äî but it's the most important thing about ${topic}.`,`Stop scrolling. This ${topic} tip will change how you think.`,`I tried ${topic} for 30 days. Here's what happened.`,`The truth about ${topic} nobody tells you.`],hook=hooks[Math.floor(Math.random()*hooks.length)],titles=[`The Truth About ${topic}`,`${topic}: What Nobody Tells You`,`I Tried ${topic} For 30 Days`,`Stop Making This ${topic} Mistake`];return{title:titles[Math.floor(Math.random()*titles.length)],hook,script:`${hook}\n\nMost people approach ${topic} completely wrong.\n\nThe secret is consistency. Not perfection. Just showing up every day.\n\nTrack your progress. Start small, stay consistent.\n\n${topic} is simpler than you think. Save this and follow for more.`,hashtags:`#${topic.replace(/\s+/g,'').toLowerCase().substring(0,20)} #shorts #viral #trending #fyp`}}
const HTML=`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>ShortsBot</title><link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}:root{--bg:#0a0a0f;--surface:#111118;--card:#18181f;--border:#22222e;--red:#ff3d3d;--orange:#ff6b35;--green:#00e676;--yellow:#ffc107;--text:#f0f0f8;--muted:#5a5a72;--safe-top:env(safe-area-inset-top,44px);--safe-bottom:env(safe-area-inset-bottom,34px)}html{height:100%;overflow:hidden}body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased}.app{display:flex;flex-direction:column;height:100vh;height:100dvh;overflow:hidden}.statusbar{height:var(--safe-top);background:var(--bg);flex-shrink:0}.header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px 10px;background:var(--bg);flex-shrink:0;border-bottom:1px solid var(--border)}.logo{display:flex;align-items:center;gap:9px}.logopill{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--red),var(--orange));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 12px rgba(255,61,61,0.4)}.logoname{font-size:19px;font-weight:800;letter-spacing:-.5px}.logoname span{color:var(--red)}.cbtn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;border:none;letter-spacing:.2px;transition:all .2s}.cbtn.off{background:rgba(255,61,61,0.12);color:var(--red);border:1px solid rgba(255,61,61,0.25)}.cbtn.on{background:rgba(0,230,118,0.1);color:var(--green);border:1px solid rgba(0,230,118,0.2)}.cdot{width:6px;height:6px;border-radius:50%;background:currentColor}.cdot.pulse{animation:blink 1.4s infinite}@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:0 0 16px}.page{display:none;padding:0 16px}.page.active{display:block}.botnav{display:flex;background:var(--surface);border-top:1px solid var(--border);padding-bottom:var(--safe-bottom);flex-shrink:0}.nbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px 6px;cursor:pointer;user-select:none}.nicon{font-size:22px;line-height:1;transition:transform .2s cubic-bezier(.34,1.56,.64,1)}.nlbl{font-size:9.5px;font-weight:700;color:var(--muted);letter-spacing:.3px;text-transform:uppercase;transition:color .15s}.nbtn.active .nicon{transform:scale(1.15)}.nbtn.active .nlbl{color:var(--red)}.shead{padding:20px 0 12px;display:flex;align-items:center;justify-content:space-between}.stitle{font-size:20px;font-weight:800;letter-spacing:-.5px}.stitle em{color:var(--red);font-style:normal}.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}.scard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;position:relative;overflow:hidden}.snum{font-size:28px;font-weight:800;letter-spacing:-1px;line-height:1;margin-top:4px}.slbl{font-size:10.5px;font-weight:600;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}.ssub{font-size:10px;margin-top:5px;color:var(--green)}.qcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;display:flex;gap:12px;align-items:center;cursor:pointer}.qcard:active{background:var(--surface)}.qthumb{width:44px;height:78px;border-radius:8px;background:linear-gradient(160deg,#1a1a2e,#16213e);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}.qinfo{flex:1;min-width:0}.qtitle{font-size:13.5px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}.qmeta{font-size:11px;color:var(--muted);margin-bottom:7px}.badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px}.blive{background:rgba(0,230,118,0.12);color:var(--green);border:1px solid rgba(0,230,118,0.25)}.bpend{background:rgba(255,193,7,0.12);color:var(--yellow);border:1px solid rgba(255,193,7,0.25)}.bdraft{background:rgba(90,90,114,0.15);color:var(--muted);border:1px solid rgba(90,90,114,0.25)}.gform{display:flex;flex-direction:column;gap:18px;padding-bottom:20px}.fgrp{display:flex;flex-direction:column;gap:8px}.flbl{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px}.finp,.fsel{width:100%;background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:13px 14px;color:var(--text);font-size:15px;outline:none;-webkit-appearance:none;transition:border-color .2s}.finp:focus,.fsel:focus{border-color:var(--red)}.prow{display:flex;flex-wrap:wrap;gap:8px}.pill{padding:7px 14px;border-radius:20px;font-size:13px;font-weight:600;border:1.5px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;transition:all .15s;user-select:none}.pill.active{border-color:var(--red);background:rgba(255,61,61,0.12);color:var(--text)}.pill:active{transform:scale(.95)}.gbtn{width:100%;padding:17px;border-radius:16px;background:linear-gradient(135deg,var(--red),var(--orange));color:white;font-size:16px;font-weight:800;border:none;cursor:pointer;box-shadow:0 6px 28px rgba(255,61,61,0.35);transition:all .15s}.gbtn:active{transform:scale(.97)}.gbtn:disabled{opacity:.5;cursor:not-allowed;transform:none}.scard2{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:14px}.srow{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer}.srow:last-child{border-bottom:none}.sinfo{flex:1;padding-right:16px}.sname{font-size:14px;font-weight:700}.sdesc{font-size:11.5px;color:var(--muted);margin-top:2px;line-height:1.4}.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);z-index:200;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .25s}.overlay.open{opacity:1;pointer-events:all}.sheet{background:var(--surface);width:100%;border-radius:24px 24px 0 0;padding:0 20px calc(var(--safe-bottom) + 20px);transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1);max-height:92vh;overflow-y:auto}.overlay.open .sheet{transform:translateY(0)}.shandle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 20px}.stit{font-size:22px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px}.ssub{font-size:13.5px;color:var(--muted);margin-bottom:20px;line-height:1.5}.plist{display:flex;flex-direction:column;gap:2px;margin-bottom:20px}.pitem{display:flex;align-items:flex-start;gap:12px;padding:10px 14px;background:var(--card);border-radius:10px;font-size:13px;line-height:1.5}.ytbtn{width:100%;padding:16px;border-radius:14px;background:white;color:#111;font-size:15px;font-weight:800;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px;box-shadow:0 4px 20px rgba(0,0,0,.3);text-decoration:none}.ytbtn:active{transform:scale(.98)}.anote{text-align:center;font-size:11px;color:var(--muted);line-height:1.6}.progs{display:flex;flex-direction:column;gap:4px;margin:16px 0}.pitem2{display:flex;align-items:center;gap:14px;padding:12px 14px;background:var(--card);border-radius:12px;opacity:.35;transition:all .3s}.pitem2.active{opacity:1}.pitem2.done{opacity:.6}.pdot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;font-weight:700;transition:all .3s}.pitem2.active .pdot{border-color:var(--red);background:rgba(255,61,61,0.15);color:var(--red);animation:ring 1.2s infinite}.pitem2.done .pdot{border-color:var(--green);background:rgba(0,230,118,0.12);color:var(--green)}@keyframes ring{0%,100%{box-shadow:0 0 0 0 rgba(255,61,61,.5)}50%{box-shadow:0 0 0 5px rgba(255,61,61,0)}}.sbox{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;font-size:12.5px;line-height:1.7;max-height:160px;overflow-y:auto;display:none;margin-bottom:14px;white-space:pre-wrap}.sbox.show{display:block}.done{text-align:center;padding:10px 0 4px;display:none}.done.show{display:block}.setupcard{background:var(--card);border:1.5px solid rgba(255,193,7,0.3);border-radius:16px;padding:18px;margin:12px 0 16px}.setupcard h3{font-size:15px;font-weight:800;margin-bottom:6px;color:var(--yellow)}.setupcard p{font-size:12.5px;color:var(--muted);line-height:1.6;margin-bottom:14px}.irow{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}.sinp{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-size:13px;outline:none;transition:border-color .2s}.sinp:focus{border-color:var(--yellow)}.savebtn{width:100%;padding:13px;border-radius:12px;background:var(--yellow);color:#111;font-size:14px;font-weight:800;border:none;cursor:pointer}.savebtn:active{transform:scale(.97)}.tz{position:fixed;top:calc(var(--safe-top) + 60px);left:50%;transform:translateX(-50%);z-index:300;pointer-events:none}.toast{background:rgba(24,24,31,.96);border:1px solid var(--border);border-radius:20px;padding:10px 18px;font-size:13px;font-weight:600;backdrop-filter:blur(16px);box-shadow:0 8px 32px rgba(0,0,0,.4);transform:scale(.85) translateY(-8px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1)}.toast.show{transform:scale(1) translateY(0);opacity:1}.empty{text-align:center;padding:40px 20px;color:var(--muted)}.empty .ei{font-size:44px;margin-bottom:10px}.empty .et{font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px}.empty .es{font-size:13px;line-height:1.5}</style></head><body>`;
const HTML2=`<div class="overlay" id="connectSheet"><div class="sheet"><div class="shandle"></div><div class="stit">Connect YouTube</div><div class="ssub">ShortsBot will create and post Shorts to your channel automatically.</div><div class="plist"><div class="pitem"><span>‚úì</span> Upload Shorts to your channel</div><div class="pitem"><span>‚úì</span> Set titles, descriptions & hashtags</div><div class="pitem"><span>‚úì</span> Schedule publishing times</div><div class="pitem"><span>‚úì</span> Read channel analytics</div></div><a class="ytbtn" href="/auth/connect"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.95-1.96C18.88 4 12 4 12 4s-6.88 0-8.59.46A2.78 2.78 0 0 0 1.46 6.42 29 29 0 0 0 1 12a29 29 0 0 0 .46 5.58 2.78 2.78 0 0 0 1.95 1.96C5.12 20 12 20 12 20s6.88 0 8.59-.46a2.78 2.78 0 0 0 1.95-1.96A29 29 0 0 0 23 12a29 29 0 0 0-.46-5.58z" fill="#FF0000"/><polygon points="9.75,15.02 15.5,12 9.75,8.98" fill="white"/></svg>Sign in with Google / YouTube</a><div class="anote">You'll be taken to Google's real sign-in page.<br>We never see or store your password.</div></div></div><div class="overlay" id="genSheet"><div class="sheet"><div class="shandle"></div><div class="stit">üé¨ Making Your Short</div><div class="ssub">AI is writing your script now...</div><div class="progs"><div class="pitem2" id="ps1"><div class="pdot">1</div><span>Writing your script...</span></div><div class="pitem2" id="ps2"><div class="pdot">2</div><span>Crafting title & hashtags</span></div><div class="pitem2" id="ps3"><div class="pdot">3</div><span>Setting up metadata</span></div><div class="pitem2" id="ps4"><div class="pdot">4</div><span>Saving to queue</span></div></div><div class="sbox" id="scriptBox"></div><div class="done" id="doneState"><div style="font-size:48px;margin-bottom:8px">üéâ</div><div style="font-size:20px;font-weight:800;margin-bottom:4px">Short is Ready!</div><div style="font-size:13px;color:var(--muted);margin-bottom:20px" id="doneSub">Added to your queue.</div><button class="gbtn" onclick="closeSheet('genSheet');resetGen()">Awesome!</button></div></div></div><div class="app"><div class="statusbar"></div><div class="header"><div class="logo"><div class="logopill">‚ö°</div><div class="logoname">Shorts<span>Bot</span></div></div><button class="cbtn off" id="connBtn" onclick="handleConnect()"><div class="cdot" id="cdot"></div><span id="connLbl">Connect</span></button></div><div class="scroll"><div class="page active" id="page-home"><div class="shead"><div class="stitle">Your <em>Dashboard</em></div></div><div class="sgrid"><div class="scard"><div style="font-size:20px;margin-bottom:4px">üé¨</div><div class="snum" id="sv1">‚Äî</div><div class="slbl">Videos</div><div class="ssub" id="sv1s">‚Äî</div></div><div class="scard"><div style="font-size:20px;margin-bottom:4px">üëÅÔ∏è</div><div class="snum" id="sv2">‚Äî</div><div class="slbl">Views</div><div class="ssub" id="sv2s">Connect channel</div></div><div class="scard"><div style="font-size:20px;margin-bottom:4px">üë•</div><div class="snum" id="sv3">‚Äî</div><div class="slbl">Subscribers</div><div class="ssub" id="sv3s">Connect channel</div></div><div class="scard"><div style="font-size:20px;margin-bottom:4px">üìÖ</div><div class="snum" id="sv4">0</div><div class="slbl">In Queue</div><div class="ssub" id="sv4s">None queued</div></div></div><div class="shead" style="padding-top:4px"><div class="stitle" style="font-size:17px">Video Queue</div><button class="cbtn off" style="border-color:rgba(255,255,255,0.12);color:var(--text);background:var(--card)" onclick="goPage('create')">+ New</button></div><div id="queueList"><div class="empty"><div class="ei">üé¨</div><div class="et">No videos yet</div><div class="es">Tap Create to generate your first Short</div></div></div></div><div class="page" id="page-create"><div class="shead"><div class="stitle">New <em>Short</em></div></div><div class="gform"><div class="fgrp"><div class="flbl">üìù Topic or Hook</div><input class="finp" id="topicInput" placeholder="e.g. 5 tips to grow on YouTube fast"></div><div class="fgrp"><div class="flbl">üé≠ Tone</div><div class="prow"><div class="pill active" onclick="pickPill(this)">Engaging</div><div class="pill" onclick="pickPill(this)">Funny üòÇ</div><div class="pill" onclick="pickPill(this)">Educational</div><div class="pill" onclick="pickPill(this)">Motivational</div></div></div><div class="fgrp"><div class="flbl">‚è±Ô∏è Length</div><select class="fsel" id="lenSel"><option value="15">15 seconds</option><option value="30">30 seconds</option><option value="60" selected>60 seconds</option></select></div><div class="fgrp"><div class="flbl">üìÖ When to Post</div><select class="fsel" id="schedSel"><option value="now">Post immediately</option><option value="1h">In 1 hour</option><option value="tam">Tomorrow 9 AM</option><option value="tpm">Tomorrow 6 PM</option><option value="ai">ü§ñ Best time (AI picks)</option></select></div><button class="gbtn" onclick="startGen()">üöÄ Generate & Schedule</button></div></div><div class="page" id="page-settings"><div class="shead"><div class="stitle"><em>Settings</em></div></div><div class="setupcard" id="setupCard"><h3>‚öôÔ∏è One-Time Setup</h3><p>Paste your Google API credentials to enable real YouTube sign-in.</p><div class="irow"><div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase">Google Client ID</div><input class="sinp" id="cidInp" placeholder="xxxx.apps.googleusercontent.com" autocapitalize="none"></div><div class="irow"><div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase">Google Client Secret</div><input class="sinp" id="csecInp" placeholder="GOCSPX-xxxx" type="password" autocapitalize="none"></div><button class="savebtn" onclick="saveSetup()">Save & Activate ‚úì</button></div><div class="scard2"><div class="srow" onclick="handleConnect()"><div class="sinfo"><div class="sname">üì∫ YouTube Account</div><div class="sdesc" id="ytDesc">Not connected ‚Äî tap to connect</div></div><div style="color:var(--muted);font-size:18px">‚Ä∫</div></div><div class="srow" id="discRow" style="display:none" onclick="disconnect()"><div class="sinfo"><div class="sname" style="color:var(--red)">Disconnect YouTube</div><div class="sdesc">Remove channel connection</div></div></div></div></div></div><nav class="botnav"><div class="nbtn active" id="nav-home" onclick="goPage('home')"><div class="nicon">üè†</div><div class="nlbl">Home</div></div><div class="nbtn" id="nav-create" onclick="goPage('create')"><div class="nicon">‚ú®</div><div class="nlbl">Create</div></div><div class="nbtn" id="nav-settings" onclick="goPage('settings')"><div class="nicon">‚öôÔ∏è</div><div class="nlbl">Settings</div></div></nav></div><div class="tz" id="tz"></div><script>let state={connected:false,configured:false,channel:null,videos:[]},curStep=0;window.addEventListener('load',async()=>{await loadStatus();await loadVideos();const p=new URLSearchParams(location.search);if(p.get('auth')==='success'){history.replaceState({},'','/');showToast('‚úÖ YouTube connected!');await loadStatus();await loadVideos()}else if(p.get('auth')==='error'){history.replaceState({},'','/');showToast('‚ùå Sign-in failed')}});async function loadStatus(){try{const r=await fetch('/api/status'),d=await r.json();state.configured=d.configured;state.connected=d.connected;state.channel=d.channel;updateUI()}catch(e){}}async function loadVideos(){try{const r=await fetch('/api/videos');state.videos=await r.json();renderQ();updateStats()}catch(e){}}function updateUI(){const b=document.getElementById('connBtn'),d=document.getElementById('cdot'),l=document.getElementById('connLbl'),desc=document.getElementById('ytDesc'),disc=document.getElementById('discRow'),sc=document.getElementById('setupCard');sc.style.display=state.configured?'none':'block';if(state.connected&&state.channel){b.className='cbtn on';d.className='cdot pulse';l.textContent=state.channel.handle||state.channel.title;desc.textContent='Connected as '+state.channel.title;disc.style.display='flex'}else{b.className='cbtn off';d.className='cdot';l.textContent='Connect';desc.textContent='Not connected ‚Äî tap to connect';disc.style.display='none'}}function updateStats(){const v=state.videos;document.getElementById('sv1').textContent=v.length||'0';document.getElementById('sv1s').textContent=v.length>0?v.length+' created':'None yet';const s=v.filter(x=>x.status==='scheduled'||x.status==='pending').length;document.getElementById('sv4').textContent=s;document.getElementById('sv4s').textContent=s>0?s+' upcoming':'None queued';if(state.channel){document.getElementById('sv2').textContent=fmt(state.channel.views||0);document.getElementById('sv3').textContent=fmt(state.channel.subscribers||0);document.getElementById('sv2s').textContent='YouTube data';document.getElementById('sv3s').textContent='YouTube data'}}function fmt(n){n=parseInt(n)||0;if(n>=1000000)return(n/1000000).toFixed(1)+'M';if(n>=1000)return(n/1000).toFixed(1)+'K';return n.toString()}function goPage(name){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.nbtn').forEach(b=>b.classList.remove('active'));document.getElementById('page-'+name).classList.add('active');document.getElementById('nav-'+name).classList.add('active');document.querySelector('.scroll').scrollTop=0}function openSheet(id){document.getElementById(id).classList.add('open')}function closeSheet(id){document.getElementById(id).classList.remove('open')}document.querySelectorAll('.overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)closeSheet(o.id)})});function handleConnect(){if(state.connected){showToast('‚úÖ Already connected');return}if(!state.configured){goPage('settings');showToast('‚öôÔ∏è Set up API keys first');return}openSheet('connectSheet')}async function disconnect(){try{await fetch('/auth/disconnect',{method:'POST'});state.connected=false;state.channel=null;updateUI();showToast('Disconnected')}catch(e){}}async function saveSetup(){const cid=document.getElementById('cidInp').value.trim(),cs=document.getElementById('csecInp').value.trim();if(!cid||!cs){showToast('‚ö†Ô∏è Both fields required');return}try{await fetch('/api/setup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clientId:cid,clientSecret:cs})});state.configured=true;updateUI();showToast('‚úÖ Saved! Tap Connect now');document.getElementById('cidInp').value='';document.getElementById('csecInp').value=''}catch(e){showToast('‚ùå Failed to save')}}function pickPill(el){el.closest('.prow').querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));el.classList.add('active')}async function startGen(){const topic=document.getElementById('topicInput').value.trim();if(!topic){showToast('‚úèÔ∏è Enter a topic first!');return}const tone=document.querySelector('#page-create .prow .pill.active')?.textContent?.replace(/[^\w\s]/g,'').trim()||'Engaging',length=parseInt(document.getElementById('lenSel').value),sv=document.getElementById('schedSel').value;openSheet('genSheet');resetGen();animStep(1);try{const r=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic,tone,length,scheduleFor:sv})}),d=await r.json();if(!d.success)throw new Error(d.error||'Failed');await delay(600);animStep(2);document.getElementById('scriptBox').textContent=d.video.script||d.video.hook;document.getElementById('scriptBox').classList.add('show');await delay(700);animStep(3);await delay(700);animStep(4);await delay(600);markDone();document.getElementById('doneSub').textContent='Added to your queue.';document.getElementById('doneState').classList.add('show');await loadVideos();document.getElementById('topicInput').value=''}catch(e){closeSheet('genSheet');showToast('‚ùå '+(e.message||'Failed'))}}function animStep(n){if(curStep>0){const p=document.getElementById('ps'+curStep);p.classList.remove('active');p.classList.add('done');p.querySelector('.pdot').textContent='‚úì'}curStep=n;document.getElementById('ps'+n).classList.add('active')}function markDone(){for(let i=1;i<=4;i++){const e=document.getElementById('ps'+i);e.classList.remove('active');e.classList.add('done');e.querySelector('.pdot').textContent='‚úì'}}function resetGen(){curStep=0;for(let i=1;i<=4;i++){const e=document.getElementById('ps'+i);e.classList.remove('active','done');e.querySelector('.pdot').textContent=i}document.getElementById('scriptBox').classList.remove('show');document.getElementById('scriptBox').textContent='';document.getElementById('doneState').classList.remove('show')}function delay(ms){return new Promise(r=>setTimeout(r,ms))}function renderQ(){const list=document.getElementById('queueList');if(!state.videos.length){list.innerHTML='<div class="empty"><div class="ei">üé¨</div><div class="et">No videos yet</div><div class="es">Tap Create to generate first Short</div></div>';return}const slbls={live:'‚óè Live',pending:'‚è≥ Scheduled',draft:'‚úèÔ∏è Draft'},scls={live:'blive',pending:'bpend',draft:'bdraft'};list.innerHTML=state.videos.map(v=>`<div class="qcard"><div class="qthumb">${v.emoji||'üé¨'}</div><div class="qinfo"><div class="qtitle">${esc(v.title)}</div><div class="qmeta">${esc(v.tone||'Engaging')}</div><span class="badge ${scls[v.status]||'bdraft'}">${slbls[v.status]||v.status}</span></div></div>`).join('')}function showToast(msg){const z=document.getElementById('tz'),t=document.createElement('div');t.className='toast';t.textContent=msg;z.appendChild(t);requestAnimationFrame(()=>requestAnimationFrame(()=>t.classList.add('show')));setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),400)},3000)}function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}</script></body></html>`;http.createServer(async(req,res)=>{const url=new URL(req.url,`http://localhost:${PORT}`),pathname=url.pathname;res.setHeader('Access-Control-Allow-Origin','*');res.setHeader('Access-Control-Allow-Methods','GET,POST,DELETE,OPTIONS');res.setHeader('Access-Control-Allow-Headers','Content-Type');if(req.method==='OPTIONS'){res.writeHead(204);res.end();return}function json(data,status=200){res.writeHead(status,{'Content-Type':'application/json'});res.end(JSON.stringify(data))}async function body(){return new Promise(r=>{let b='';req.on('data',c=>b+=c);req.on('end',()=>{try{r(JSON.parse(b))}catch{r({})}})})}try{if(pathname==='/'||pathname==='/index.html'){res.writeHead(200,{'Content-Type':'text/html'});return res.end(HTML+HTML2)}if(pathname==='/api/status'){const c=lc(),d=ld();return json({configured:!!(c.clientId&&c.clientSecret),connected:!!d.tokens,channel:d.channel})}if(pathname==='/api/setup'&&req.method==='POST'){const b=await body(),c=lc();if(b.clientId)c.clientId=b.clientId.trim();if(b.clientSecret)c.clientSecret=b.clientSecret.trim();sc(c);return json({success:true})}if(pathname==='/auth/connect'){const c=lc();if(!c.clientId)return json({error:'Not configured'},400);res.writeHead(302,{Location:authUrl(c.clientId)});return res.end()}if(pathname==='/auth/callback'){const code=url.searchParams.get('code'),error=url.searchParams.get('error');if(error||!code){res.writeHead(302,{Location:'/?auth=error'});return res.end()}const c=lc(),tokens=await post('oauth2.googleapis.com','/token',{code,client_id:c.clientId,client_secret:c.clientSecret,redirect_uri:`${BASE}/auth/callback`,grant_type:'authorization_code'});if(tokens.error){res.writeHead(302,{Location:'/?auth=error'});return res.end()}const db=ld();db.tokens={access_token:tokens.access_token,refresh_token:tokens.refresh_token,expiry:Date.now()+(tokens.expires_in*1000)};try{db.channel=await channel(tokens.access_token)}catch(e){}sd(db);res.writeHead(302,{Location:'/?auth=success'});return res.end()}if(pathname==='/auth/disconnect'&&req.method==='POST'){const db=ld();db.tokens=null;db.channel=null;sd(db);return json({success:true})}if(pathname==='/api/generate'&&req.method==='POST'){const b=await body();if(!b.topic)return json({error:'Topic required'},400);const g=gen(b.topic,b.tone||'Engaging',parseInt(b.length)||60),db=ld(),emojis=['üî•','üí°','üöÄ','üéØ','‚ú®'],video={id:Date.now().toString(),topic:b.topic,tone:b.tone||'Engaging',length:parseInt(b.length)||60,title:g.title,hook:g.hook,script:g.script,hashtags:g.hashtags,status:'draft',createdAt:new Date().toISOString(),scheduledFor:b.scheduleFor||null,emoji:emojis[Math.floor(Math.random()*emojis.length)]};db.videos.unshift(video);if(db.videos.length>50)db.videos=db.videos.slice(0,50);sd(db);return json({success:true,video})}if(pathname==='/api/videos'&&req.method==='GET'){const db=ld();return json(db.videos)}if(pathname.startsWith('/api/videos/')&&req.method==='DELETE'){const id=pathname.split('/').pop(),db=ld();db.videos=db.videos.filter(v=>v.id!==id);sd(db);return json({success:true})}res.writeHead(404);res.end(JSON.stringify({error:'Not found'}))}catch(err){console.error(err);res.writeHead(500);res.end(JSON.stringify({error:err.message}))}}).listen(PORT,'0.0.0.0',()=>{console.log(`\n‚ö° ShortsBot running on port ${PORT}\n`)});
